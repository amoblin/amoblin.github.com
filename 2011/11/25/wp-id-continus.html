<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Linghua Zhang" />
    <title>wordpress blog id不连续的解决</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="setImpl" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/styles/style.css">
    <link rel="stylesheet" href="/media/styles/github.css">
    <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <h1>wordpress blog id不连续的解决</h1>
        </header>
        <nav>
        <span><a title="home page" class="" href="/">home</a></span>
        <span><a title="tags" class="" href="/tags.html">tags</a></span>
        <span><a title="blogroll" class="" href="/links.html">links</a></span>
        <span><a title="subscribe me" class="" href="/atom.xml">feed</a></span>
        </nav>
        <article class="content">
        <section class="post">
<!-- id: 7 -->
<!-- publish: YES -->
<p>wp两个特性：自动保存(auto save) 和 版本记录(revisions)。</p>
<p>post_status: auto-draft, draft</p>
<p>auto-draft是系统自动生成，控制台不可见，draft是草稿。</p>
<p>post_type: post, revision, page</p>
<p>post_parent: 描述从哪个id演变而来。revision版的不为0，原始的为0.</p>
<!-- more -->
<div class="section" id="id1">
<h2>修改配置文件</h2>
<p>修改wp-config.php,增加两行：</p>
<pre class="code php literal-block">
<span class="other">define( 'AUTOSAVE_INTERVAL', 36000 );
define('WP_POST_REVISIONS', false );</span>
</pre>
<p>第一行中单位是秒。 这里每10小时自动保存一次。</p>
<p>第二行是禁用版本历史的 Revisions的设置选项说明如下：</p>
<p>There are options, but they are hidden well :) There is a constant (not even filterable) that can be set by a plugin or in your wp-settings.php file:</p>
<p>WP_POST_REVISIONS:</p>
<p>true (default), -1: store every revision
false, 0: do not store any revisions (except the one autosave per post)
(int) &gt; 0: store that many revisions (+1 autosave) per post. Old revisions are automatically deleted.</p>
<p>设置这个变量为false或0的话，还是会保留一个历史版本的。</p>
<p>另外，在每次新建文章时，会自动保存一个记录，要禁用的话，只能硬编码。</p>
<p>修改wp-admin/post.php和wp-admin/post-new.php，找到如下内容，注释掉。</p>
<pre class="code php literal-block">
<span class="other">wp_enqueue_script('autosave');</span>
</pre>
<p>修改wp-admin/post-new.php，在代码的最后几行，有：</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">&lt;string&gt;</tt>, line 57)</p>
<p>Error in &quot;code-block&quot; directive:
unknown option: &quot;lineos&quot;.</p>
<pre class="literal-block">
.. code-block:: php
    :lineos:

    38 // Show post form.
    39 $post = get_default_post_to_edit( $post_type, true);
    40 $post_ID = $post-&gt;ID;
    41 include('edit-form-advanced.php');
    42 include('./admin-footer.php');
    43 ?&gt;

</pre>
</div>
<p>将第39行最后的true改为false：</p>
<pre class="code php literal-block">
<span class="other">39 $post = get_default_post_to_edit( $post_type, false);</span>
</pre>
<div class="section" id="id2">
<h3>硬编码修改</h3>
<p>此外，还要修改wp-admin/include/post.php，找到如下代码：</p>
<pre class="code php literal-block">
<span class="other">418     if ( $create_in_db ) {
419         // Cleanup old auto-drafts more than 7 days old
420         $old_posts = $wpdb-&gt;get_col( &quot;SELECT ID FROM $wpdb-&gt;posts WHERE post_status = 'auto-draft' AND DATE_SUB( NOW(), INTERVAL 7 DAY ) &gt; post_date&quot; );
421         foreach ( (array) $old_posts as $delete )
422             wp_delete_post( $delete, true ); // Force delete
423         $post_id = wp_insert_post( array( 'post_title' =&gt; __( 'Auto Draft' ), 'post_type' =&gt; $post_type, 'post_status' =&gt; 'auto-draft' ) );
424         $post = get_post( $post_id );
425         if ( current_theme_supports( 'post-formats' ) &amp;&amp; post_type_supports( $post-&gt;post_type, 'post-formats' ) &amp;&amp; get_option( 'default_post_format' ) )
426             set_post_format( $post, get_option( 'default_post_format' ) );
427     } else {</span>
</pre>
<p>将if分支中的内容，直到424行，修改成下面的内容：</p>
<pre class="code php literal-block">
<span class="other">418     if ( $create_in_db ) {
419         // modify by akii start
420         global $current_user;
421         $post_auto_draft = $wpdb-&gt;get_row( &quot;SELECT * FROM $wpdb-&gt;posts WHERE post_status = 'auto-draft' AND post_author = $current_user-&gt;ID ORDER BY ID ASC LIMIT 1&quot;||        );
422         if ($post_auto_draft){
423             $post = $post_auto_draft;
424         } else {
425             $post_id = wp_insert_post( array( 'post_title' =&gt; __( 'Auto Draft' ), 'post_type' =&gt; $post_type, 'post_status' =&gt; 'auto-draft' ) );
426             $post = get_post( $post_id );
427         }
428         // modify by akii end
429         if ( current_theme_supports( 'post-formats' ) &amp;&amp; post_type_supports( $post-&gt;post_type, 'post-formats' ) &amp;&amp; get_option( 'default_post_format' ) )
430             set_post_format( $post, get_option( 'default_post_format' ) );
431     } else {</span>
</pre>
<p>参考自 <a class="reference external" href="http://www.akii.org/wordpress-3-0-prohibit-to-historical-versions-and-automatically-save-the-draft.html">Akii Snow 的博客</a></p>
</div>
</div>
<div class="section" id="id3">
<h2>禁用版本记录</h2>
<p>修改wp-config.php,增加一行：</p>
<pre class="code php literal-block">
<span class="other">define('WP_POST_REVISIONS', false );</span>
</pre>
</div>
<div class="section" id="id4">
<h2>清理数据库中版本历史</h2>
<ol class="arabic simple">
<li>手工清理</li>
<li>安装wp插件</li>
</ol>
<p>自动保存的记录是如下记录：</p>
<pre class="code sql literal-block">
<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="operator">`</span><span class="name">wp_posts</span><span class="operator">`</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">post_status</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal string single">'auto-draft'</span> <span class="punctuation">;</span>
</pre>
<p>而版本记录是：</p>
<pre class="code sql literal-block">
<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="operator">`</span><span class="name">wp_posts</span><span class="operator">`</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">post_status</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal string single">'inherit'</span><span class="punctuation">;</span>
</pre>
<p>手工保存的是：</p>
<pre class="code sql literal-block">
<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="operator">`</span><span class="name">wp_posts</span><span class="operator">`</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">post_status</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal string single">'draft'</span> <span class="punctuation">;</span>
</pre>
</div>
<div class="section" id="id5">
<h2>删除历史冗余记录</h2>
<p>删除草稿记录，自动保存记录，版本变迁记录：</p>
<pre class="code sql literal-block">
<span class="keyword">delete</span> <span class="keyword">from</span> <span class="operator">`</span><span class="name">wp_posts</span><span class="operator">`</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">post_status</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal string single">'inherit'</span> <span class="keyword">or</span> <span class="operator">`</span><span class="name">post_status</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal string single">'auto-draft'</span> <span class="keyword">or</span> <span class="operator">`</span><span class="name">post_status</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal string single">'draft'</span><span class="punctuation">;</span>
</pre>
</div>
<div class="section" id="id6">
<h2>禁用自动保存的插件</h2>
<p>有老外写了这个禁用自动保存的插件， <a class="reference external" href="http://www.untwistedvortex.com/2008/06/27/adjust-wordpress-autosave-or-disable-it-completely/">文章在此</a></p>
<p><a class="reference external" href="&lt;http://samm.dreamhosters.com/wordpress/plugins/disable-autosave.php&gt;">插件下载地址</a></p>
</div>
<div class="section" id="id9">
<h2>删除版本历史，禁用版本保存的插件</h2>
<p><a class="reference external" href="http://wordpress.org/extend/plugins/disable-revisions/">disable revisions</a></p>
</div>
<div class="section" id="id">
<h2>将id顺序排列</h2>
<p>涉及到4张表，都要更新。尝试使用循环解决，未遂。只得手工改。</p>
<p>下面的例子将id为108的记录修改id为7。</p>
<pre class="code sql literal-block">
<span class="keyword">update</span> <span class="operator">`</span><span class="name">wp_posts</span><span class="operator">`</span> <span class="keyword">set</span> <span class="operator">`</span><span class="name">id</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">7</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">id</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">108</span><span class="punctuation">;</span>
<span class="keyword">update</span> <span class="operator">`</span><span class="name">wp_term_relationships</span><span class="operator">`</span> <span class="keyword">set</span> <span class="operator">`</span><span class="name">object_id</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">7</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">object_id</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">108</span><span class="punctuation">;</span>
<span class="keyword">update</span> <span class="operator">`</span><span class="name">wp_postmeta</span><span class="operator">`</span> <span class="keyword">set</span> <span class="operator">`</span><span class="name">post_id</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">7</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">post_id</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">108</span><span class="punctuation">;</span>
<span class="keyword">update</span> <span class="operator">`</span><span class="name">wp_comments</span><span class="operator">`</span> <span class="keyword">set</span> <span class="operator">`</span><span class="name">comment_post_ID</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">7</span> <span class="keyword">where</span> <span class="operator">`</span><span class="name">comment_post_ID</span><span class="operator">`</span> <span class="operator">=</span> <span class="literal number integer">108</span><span class="punctuation">;</span>
</pre>
<p>新建博客仍有问题。新博客的id并不小！</p>
<p>保持id连续的原则：</p>
<ol class="arabic simple">
<li>不要删博客</li>
<li>新建的博客一定要保存</li>
<li>禁用自动保存和版本记录。</li>
</ol>
<p>参考自: <a class="reference external" href="http://www.williamlong.info/archives/1416.html">月光博客</a></p>
</div>
</section>
<section class="meta">

<span class="tags">
  tagged by 
  
</span>

<span class="time">
  <time datetime="2011-11-25">2011-11-25</time>
</span>
</section>


        </article>
        <!-- PingLun.La Begin -->
        <div id="pinglunla_here"></div><a href="http://pinglun.la/" id="logo-pinglunla">评论啦</a><script type="text/javascript" src="http://static.pinglun.la/md/pinglun.la.js" charset="utf-8"></script>
        <!-- PingLun.La End -->
        <div id="copy">&copy; 2012 amoblin | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext ii">sext ii</a></div>
      </div>
    </div> <!--! end of #container -->
  </body>
</html>
