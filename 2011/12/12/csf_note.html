<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Linghua Zhang" />
    <title>CSF学习笔记</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="/atom.xml" rel="alternate" title="setImpl" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/styles/style.css">
    <link rel="stylesheet" href="/media/styles/github.css">
    <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <h1>CSF学习笔记</h1>
        </header>
        <nav>
        <span><a title="home page" class="" href="/">home</a></span>
        <span><a title="tags" class="" href="/tags.html">tags</a></span>
        <span><a title="blogroll" class="" href="/links.html">links</a></span>
        <span><a title="subscribe me" class="" href="/atom.xml">feed</a></span>
        </nav>
        <article class="content">
        <section class="post">
<!-- id: 13 -->
<div class="contents topic" id="id1">
<p class="topic-title first">目录</p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id10">相关数据结构解析</a></li>
<li><a class="reference internal" href="#id3" id="id11">初始化CSF数据结构</a><ul>
<li><a class="reference internal" href="#csf-conf-init" id="id12">初始化默认值 csf_conf_init</a></li>
<li><a class="reference internal" href="#config-init" id="id13">读取配置文件初始化 config_init</a></li>
<li><a class="reference internal" href="#mp-init" id="id14">初始化内存池 mp_init</a></li>
<li><a class="reference internal" href="#mod-config-init-module-c" id="id15">初始化模块配置: mod_config_init &#64; module.c</a></li>
<li><a class="reference internal" href="#pipeline-init-pipeline-c" id="id16">初始化管道 pipeline_init &#64; pipeline.c</a></li>
<li><a class="reference internal" href="#app-proto-init-protocol-c" id="id17">初始化协议模块 app_proto_init &#64; protocol.c</a></li>
</ul>
</li>
<li><a class="reference internal" href="#http-protocol-init-http-c" id="id18">http协议钩子设置 protocol_init &#64; http.c</a></li>
<li><a class="reference internal" href="#id4" id="id19">初始化协议服务</a><ul>
<li><a class="reference internal" href="#socket" id="id20">初始化Socket</a></li>
<li><a class="reference internal" href="#id5" id="id21">设置用户和组</a></li>
<li><a class="reference internal" href="#event-handler-init" id="id22">事件句柄初始化 event_handler_init</a></li>
<li><a class="reference internal" href="#http" id="id23">http事件处理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#io" id="id24">IO模型</a></li>
<li><a class="reference internal" href="#id6" id="id25">CSF线程树研究</a></li>
<li><a class="reference internal" href="#apache-bench" id="id26">Apache Bench 测试</a></li>
<li><a class="reference internal" href="#id7" id="id27">遇到的问题及解决</a><ul>
<li><a class="reference internal" href="#id8" id="id28">管道描述符错误</a></li>
<li><a class="reference internal" href="#id9" id="id29">响应请求不超过40次错误</a></li>
<li><a class="reference internal" href="#ab" id="id30">之前ab测试</a></li>
</ul>
</li>
</ul>
</div>
<!-- more -->
<!-- .. footer:: ###Page### -->
<p>CSF是一个通用服务框架(Common Server Frame)，通过动态加载各种服务，如HTTP，FTP，SMTP等，来实现HTTP服务器，FTP服务器，SMTP服务器。</p>
<p>csfd为主守护进程，由它创建csfd-worker进程。每当csfd-worker进程以外退出后，都会被csfd重新创建，实现自动重启。</p>
<p>所以核心在csfd-worker程序。</p>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id10">相关数据结构解析</a></h2>
<p>csf默认配置文件是当前目录下的csf.conf，可以通过-f参数指定。</p>
<p>和配置文件中信息对应的结构体主要有如下几个：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">26</span> <span style="color: #008000; font-weight: bold">typedef</span> <span style="color: #008000; font-weight: bold">struct</span> csf_conf {<br/><span style="color: #666666">27</span>     COMM_PROTO_OPS <span style="color: #666666">*</span> cp_ops;<br/><span style="color: #666666">28</span>     <span style="color: #B00040">int</span> server_port;<br/><span style="color: #666666">29</span>     <span style="color: #B00040">int</span> server_timeout;<br/><span style="color: #666666">30</span>     <span style="color: #B00040">int</span> pipeline_queue_size;<br/><span style="color: #666666">31</span>     <span style="color: #B00040">int</span> daemonize;<br/><span style="color: #666666">32</span>     <span style="color: #B00040">int</span> request_timeout;<br/><span style="color: #666666">33</span>     <span style="color: #B00040">int</span> monitor_enable;<br/><span style="color: #666666">34</span>     <span style="color: #B00040">int</span> monitor_port;<br/><span style="color: #666666">35</span>     <span style="color: #B00040">char</span>    server_protocol[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">36</span>     <span style="color: #B00040">char</span>    protocol_module[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">37</span>     <span style="color: #B00040">char</span>    user[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">38</span>     <span style="color: #B00040">char</span>    group[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">39</span>     <span style="color: #B00040">char</span>    log_ident[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">40</span>     <span style="color: #B00040">char</span>    bind_ip[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">41</span>     <span style="color: #B00040">char</span>    mod_dir[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">42</span>     <span style="color: #B00040">char</span>    monitor_bind_ip[CONF_ITEM_LEN <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">43</span> } CSF_CONF;<br/></pre></div>
<p>在全局变量main_conf保存。</p>
<p>其中第一个数据成员cp_ops是指向TCP或UDP结构体的指针，它指向的结构体定义为：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">36</span> <span style="color: #008000; font-weight: bold">struct</span> comm_proto_ops {<br/><span style="color: #666666">37</span>     <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">char</span> <span style="color: #666666">*</span> proto_name;<br/><span style="color: #666666">38</span>     <span style="color: #B00040">int</span> sockfd;<br/><span style="color: #666666">39</span>     PROTO_INIT <span style="color: #666666">*</span> proto_init;<br/><span style="color: #666666">40</span>     CONN_HANDLER <span style="color: #666666">*</span> conn_handler;<br/><span style="color: #666666">41</span>     SOCKET_EVENT_HANDLER<span style="color: #666666">*</span> event_handler;<br/><span style="color: #666666">42</span>     SEND_BACK<span style="color: #666666">*</span> send_back;<br/><span style="color: #666666">43</span>     SOCKET_SENDFILE<span style="color: #666666">*</span> send_file;<br/><span style="color: #666666">44</span>     WRITEV_BACK<span style="color: #666666">*</span> writev_back;<br/><span style="color: #666666">45</span>     CONN_CLOSE<span style="color: #666666">*</span> conn_close;<br/><span style="color: #666666">46</span>     PORT_CLOSE<span style="color: #666666">*</span> port_close;<br/><span style="color: #666666">47</span>     WRITE_BACK<span style="color: #666666">*</span> write_back;<br/><span style="color: #666666">48</span> };<br/></pre></div>
<p>全局变量csf_comm_proto，是含有2个上述结构体元素的数组，元素分别为TCP，UDP的定义实现。保存tcp和udp类型的服务。根据服务的类型，cp_ops指向对应的数组元素。</p>
<p>tcp类型的结构定义：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">46</span> COMM_PROTO_OPS tcp_ops <span style="color: #666666">=</span> {<br/><span style="color: #666666">47</span>     .proto_name <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;tcp&quot;</span>,<br/><span style="color: #666666">48</span>     .sockfd <span style="color: #666666">=</span> <span style="color: #666666">-1</span>,<br/><span style="color: #666666">49</span>     .proto_init <span style="color: #666666">=</span> tcp_socket_init,<br/><span style="color: #666666">50</span>     .conn_handler <span style="color: #666666">=</span> tcp_conn_handler,<br/><span style="color: #666666">51</span>     .event_handler <span style="color: #666666">=</span> tcp_socket_event_handler,<br/><span style="color: #666666">52</span>     .send_back <span style="color: #666666">=</span> tcp_send_back,<br/><span style="color: #666666">53</span>     .conn_close <span style="color: #666666">=</span> tcp_conn_close,<br/><span style="color: #666666">54</span>     .port_close <span style="color: #666666">=</span> tcp_port_close,<br/><span style="color: #666666">55</span>     .send_file <span style="color: #666666">=</span> tcp_sendfile,<br/><span style="color: #666666">56</span>     .writev_back <span style="color: #666666">=</span> tcp_writev,<br/><span style="color: #666666">57</span>     .write_back <span style="color: #666666">=</span> tcp_write<br/><span style="color: #666666">58</span> };<br/></pre></div>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id11">初始化CSF数据结构</a></h2>
<p>csfd-worker根据配置文件进行模块参数的初始化，由函数csf_init负责。</p>
<p>具体分为：初始化默认值，读取配置文件初始化。</p>
<div class="section" id="csf-conf-init">
<h3><a class="toc-backref" href="#id12">初始化默认值 csf_conf_init</a></h3>
<blockquote>
<ol class="arabic simple">
<li>将main_conf的各项初始化为默认值。</li>
</ol>
</blockquote>
</div>
<div class="section" id="config-init">
<h3><a class="toc-backref" href="#id13">读取配置文件初始化 config_init</a></h3>
<blockquote>
<ol class="arabic simple">
<li>根据配置文件中[server]段初始化相应数据成员。</li>
<li>根据服务的类型（tcp or udp）挂上对应类型的结构体。</li>
</ol>
</blockquote>
</div>
<div class="section" id="mp-init">
<h3><a class="toc-backref" href="#id14">初始化内存池 mp_init</a></h3>
<p>红黑树内存池。</p>
</div>
<div class="section" id="mod-config-init-module-c">
<h3><a class="toc-backref" href="#id15">初始化模块配置: mod_config_init &#64; module.c</a></h3>
<blockquote>
<ol class="arabic simple">
<li>根据mod_dir动态加载模块。比如http.so，同时将动态库函数_protocol_init和静态全局变量_protocol_init对应起来。</li>
<li>加载其后各段。比如http_io.so, http_upload.so，同时_mod_init函数。</li>
</ol>
</blockquote>
</div>
<div class="section" id="pipeline-init-pipeline-c">
<h3><a class="toc-backref" href="#id16">初始化管道 pipeline_init &#64; pipeline.c</a></h3>
<p>初始化多线程队列</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">36</span> <span style="color: #408080; font-style: italic">/* Request Queue Control Block \*/</span><br/><span style="color: #666666">37</span> <span style="color: #008000; font-weight: bold">typedef</span> <span style="color: #008000; font-weight: bold">struct</span> rqcb {<br/><span style="color: #666666">38</span>     pthread_mutex_t         mutex;<br/><span style="color: #666666">39</span>     pthread_cond_t          cond;<br/><span style="color: #666666">40</span>     <span style="color: #008000; font-weight: bold">struct</span> request_queue    request_head;    <span style="color: #408080; font-style: italic">/* The request queue head \*/</span><br/><span style="color: #666666">41</span>     RB_ENTRY(rqcb)          stage_entry;<br/><span style="color: #666666">42</span>     <span style="color: #008000; font-weight: bold">struct</span> rqcb            <span style="color: #666666">*</span> next_rqcb;   <span style="color: #408080; font-style: italic">/* next request queue \*/</span><br/><span style="color: #666666">43</span>     <span style="color: #B00040">char</span>                    mod_name[MAX_MOD_NAME_LEN];<br/><span style="color: #666666">44</span>     <span style="color: #B00040">int</span>                     queue_id;<br/><span style="color: #666666">45</span>     <span style="color: #408080; font-style: italic">/* if the pipeline need to return when it done, set it to true*/</span><br/><span style="color: #666666">46</span>     <span style="color: #B00040">uint32_t</span>                queue_len; <span style="color: #408080; font-style: italic">/* current request queue length \*/</span><br/><span style="color: #666666">47</span>     <span style="color: #B00040">uint32_t</span>                thread_num; <span style="color: #408080; font-style: italic">/* current request queue length \*/</span><br/><span style="color: #666666">48</span>     <span style="color: #B00040">uint32_t</span>                delay;<br/><span style="color: #666666">49</span>     REQUEST_INIT           <span style="color: #666666">*</span> request_init;   <span style="color: #408080; font-style: italic">/* Each request initializer \*/</span><br/><span style="color: #666666">50</span>     REQUEST_DEINIT         <span style="color: #666666">*</span> request_deinit;     <span style="color: #408080; font-style: italic">/* Each request initializer \*/</span><br/><span style="color: #666666">51</span>     REQUEST_HANDLER        <span style="color: #666666">*</span> request_handler;  <span style="color: #408080; font-style: italic">/* Each request handler \*/</span><br/><span style="color: #666666">52</span>     <span style="color: #B00040">uint32_t</span>                rqst_num;         <span style="color: #408080; font-style: italic">/* request number \*/</span><br/><span style="color: #666666">53</span>     <span style="color: #B00040">uint64_t</span>                request_count;    <span style="color: #408080; font-style: italic">/* how many submitted requests \*/</span><br/><span style="color: #666666">54</span> } RQCB;<br/></pre></div>
</div>
<div class="section" id="app-proto-init-protocol-c">
<h3><a class="toc-backref" href="#id17">初始化协议模块 app_proto_init &#64; protocol.c</a></h3>
<p>定义ppp是如下的结构体变量：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">38</span> <span style="color: #008000; font-weight: bold">typedef</span> <span style="color: #008000; font-weight: bold">struct</span> protocol_parameter{<br/><span style="color: #666666">39</span>     VCB<span style="color: #666666">*</span> vcbp;<br/><span style="color: #666666">40</span>     PROTO_CONFIG<span style="color: #666666">*</span> pcp;<br/><span style="color: #666666">41</span>     COMM_HANDLE<span style="color: #666666">*</span> chp;<br/><span style="color: #666666">42</span> } PROTO_PARA;<br/></pre></div>
<p>其中pcp(协议配置指针 protocol config pointer)指向全局变量pc：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">20</span> PROTO_CONFIG pc <span style="color: #666666">=</span> {<br/><span style="color: #666666">21</span>     .protocol_session_start <span style="color: #666666">=</span> <span style="color: #008000">NULL</span>,<br/><span style="color: #666666">22</span>     .protocol_session_entry <span style="color: #666666">=</span> <span style="color: #008000">NULL</span>,<br/><span style="color: #666666">23</span>     .protocol_session_end <span style="color: #666666">=</span> <span style="color: #008000">NULL</span>,<br/><span style="color: #666666">24</span>     .local_entry <span style="color: #666666">=</span> <span style="color: #008000">NULL</span>,<br/><span style="color: #666666">25</span> };<br/></pre></div>
<p>PROTO_CONFIG结构体定义如下：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">31</span> <span style="color: #008000; font-weight: bold">typedef</span> <span style="color: #008000; font-weight: bold">struct</span> protocol_configs {<br/><span style="color: #666666">32</span>     PROTOCOL_SESSION_START<span style="color: #666666">*</span> protocol_session_start;<br/><span style="color: #666666">33</span>     PROTOCOL_SESSION_ENTRY<span style="color: #666666">*</span> protocol_session_entry;<br/><span style="color: #666666">34</span>     PROTOCOL_SESSION_END<span style="color: #666666">*</span> protocol_session_end;<br/><span style="color: #666666">35</span>     LOCAL_ENTRY<span style="color: #666666">*</span> local_entry;<br/><span style="color: #666666">36</span> } PROTO_CONFIG;<br/></pre></div>
<p>接下来使用动态链接库函数指针执行初始化函数：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">90</span>         rv <span style="color: #666666">=</span> _protocol_init(prot_name, <span style="color: #666666">&amp;</span>ppp);<br/></pre></div>
<p>具体执行的函数在libprotocol.c中。主要做以下几方面工作：</p>
<ul class="simple">
<li>初始化日志</li>
<li>初始化内存池</li>
<li>初始化监控器</li>
<li>初始化提交请求</li>
<li>设置全局变量g_pcp指针指向全局变量pcp</li>
<li>执行服务的protocol_init函数进行服务初始化</li>
</ul>
</div>
</div>
<div class="section" id="http-protocol-init-http-c">
<h2><a class="toc-backref" href="#id18">http协议钩子设置 protocol_init &#64; http.c</a></h2>
<p>protocol_init 函数主要设置libprotocol中的全局变量g_pcp结构体：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">433</span>     set_protocol_session_start(http_session_start);<br/><span style="color: #666666">434</span>     set_protocol_session_entry(http_session_entry);<br/><span style="color: #666666">435</span>     set_protocol_session_end(http_session_end);<br/></pre></div>
<p>最终将http会话处理设置到全局变量pc中去。从而使：</p>
<p>pc.protocol_session_start = http_session_start
pc.protocol_session_entry = http_session_entry
pc.protocol_session_end = http_session_end</p>
<p>至此，所有钩子绑定完毕。一切就绪。</p>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id19">初始化协议服务</a></h2>
<p>初始化完毕后，开始启动服务。</p>
<p>由server.c文件中server_init函数完成。根据初始化的内容，设置对应的协议服务。</p>
<div class="section" id="socket">
<h3><a class="toc-backref" href="#id20">初始化Socket</a></h3>
<p>使用proto_init指向的函数初始化Socket。比如HTTP的话是TCP套接字。</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">252</span>         fd <span style="color: #666666">=</span> ops<span style="color: #666666">-&gt;</span>proto_init(conf<span style="color: #666666">-&gt;</span>server_port,<br/><span style="color: #666666">253</span>             conf<span style="color: #666666">-&gt;</span>bind_ip, conf<span style="color: #666666">-&gt;</span>server_timeout);<br/><span style="color: #666666">254</span><br/></pre></div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id21">设置用户和组</a></h3>
<p>(在配置文件中指定)，比如以www用户和组运行程序。以提高安全性。</p>
<p>程序禁止以root用户和wheel组启动。</p>
</div>
<div class="section" id="event-handler-init">
<h3><a class="toc-backref" href="#id22">事件句柄初始化 event_handler_init</a></h3>
<p>初始化管道，非阻塞。</p>
<p>设置事件库 socket_event_handler（之前应该已经绑定到tcp或upd上了）。</p>
<p>如果绑定到tcp，则使用tcp_socket_event_handler处理。</p>
</div>
<div class="section" id="http">
<h3><a class="toc-backref" href="#id23">http事件处理</a></h3>
<p>当有用户请求时，执行一遍http_session_start, http_session_entry, http_session_end。</p>
<p>根据请求的类型进入不同的流水线，以及不同的level。排到线程队列中去。</p>
</div>
</div>
<div class="section" id="io">
<h2><a class="toc-backref" href="#id24">IO模型</a></h2>
<p>一个模块(module)可能包含多个管道(pipeline)，每个管道包含多个level，每个level对应一个.so文件。</p>
<p>每个level都有自己的线程池，各个level之间通过消息队列通信。</p>
<p>举例来说，http模块包含http和monitor两个管道。http管道包含io和upload两个level，对应http_io.so和http_upload.so文件。每个http请求都分到这两个level中排队，按照FIFO处理。</p>
<p>前端单线程。</p>
<p>后端线程池异步。使线程数固定。</p>
<p>服务器连接套接字的IO类型为非阻塞式。代码在tcp.c中：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">733</span>     retval <span style="color: #666666">=</span> fcntl(connfd, F_GETFL, <span style="color: #666666">0</span>);<br/><span style="color: #666666">734</span>     <span style="color: #0000FF">if</span>(retval <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>) {<br/><span style="color: #666666">735</span>         WLOG_ERR(<span style="color: #BA2121">&quot;fcntl() error: %s&quot;</span>, strerror(errno));<br/><span style="color: #666666">736</span>         <span style="color: #008000; font-weight: bold">return</span>;<br/><span style="color: #666666">737</span>     }<br/><span style="color: #666666">738</span>     (<span style="color: #B00040">void</span>)fcntl(connfd, F_SETFL, retval <span style="color: #666666">|</span> O_NONBLOCK);<br/></pre></div>
<p>当建立连接以后，执行connection_made：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">753</span>     <span style="color: #408080; font-style: italic">/* Process the data when the connection is made \*/</span><br/><span style="color: #666666">754</span>     (<span style="color: #B00040">void</span>)connection_made(csp);<br/></pre></div>
<p>data.c中connection_made函数体：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">18</span> <span style="color: #B00040">int</span><br/><span style="color: #666666">19</span> connection_made(CONN_STATE<span style="color: #666666">*</span> csp)<br/><span style="color: #666666">20</span> {<br/><span style="color: #666666">21</span>     CONN_INFO<span style="color: #666666">*</span> cip;<br/><span style="color: #666666">22</span><br/><span style="color: #666666">23</span>     <span style="color: #0000FF">if</span> (csp <span style="color: #666666">==</span> <span style="color: #008000">NULL</span>) {<br/><span style="color: #666666">24</span>         WLOG_DEBUG(<span style="color: #BA2121">&quot;csp is NULL!&quot;</span>);<br/><span style="color: #666666">25</span>         <span style="color: #008000; font-weight: bold">return</span> (CSF_ERR);<br/><span style="color: #666666">26</span>     }<br/><span style="color: #666666">27</span>     cip <span style="color: #666666">=</span> <span style="color: #666666">&amp;</span>(csp<span style="color: #666666">-&gt;</span>ci);<br/><span style="color: #666666">28</span><br/><span style="color: #666666">29</span>     ip2str(cip, ip_str, <span style="color: #666666">16</span>);<br/><span style="color: #666666">30</span>     WLOG_INFO(<span style="color: #BA2121">&quot;Connection made, fd: %d, IP: %s&quot;</span>, cip<span style="color: #666666">-&gt;</span>fd, ip_str);<br/><span style="color: #666666">31</span>     connection_counter<span style="color: #666666">++</span>;<br/><span style="color: #666666">32</span>     csp<span style="color: #666666">-&gt;</span>data <span style="color: #666666">=</span> do_protocol_session_start(cip);<br/><span style="color: #666666">33</span>     <span style="color: #008000; font-weight: bold">return</span> (CSF_OK);<br/><span style="color: #666666">34</span> }<br/></pre></div>
<p>可以看出调用do_protocol_session_start函数。</p>
<p>而最终调用protocol_session_start函数。</p>
<p>如前所述，http模块中就是http_session_start函数。</p>
<p>http_session_start函数设置http_requset相关，保存在HTTP_REQUEST类型的变量my_http_req中：</p>
<p>HTTP_REQUEST结构体定义如下：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"> <span style="color: #666666">96</span> <span style="color: #008000; font-weight: bold">typedef</span> <span style="color: #008000; font-weight: bold">struct</span> http_request_data<br/> <span style="color: #666666">97</span> {<br/> <span style="color: #666666">98</span>     <span style="color: #B00040">int</span> request_fd;             <span style="color: #408080; font-style: italic">/* the file descriptor of socket \*/</span><br/> <span style="color: #666666">99</span>     <span style="color: #B00040">char</span><span style="color: #666666">*</span> request_data;         <span style="color: #408080; font-style: italic">/* the full request string \*/</span><br/><span style="color: #666666">100</span>     <span style="color: #B00040">char</span><span style="color: #666666">*</span> request_data_backup;<br/><span style="color: #666666">101</span>     <span style="color: #B00040">char</span> upload_buf[UPLOAD_BUF_SIZE <span style="color: #666666">+</span> <span style="color: #666666">1</span>];<br/><span style="color: #666666">102</span>     <span style="color: #B00040">ssize_t</span> upload_buf_len;<br/><span style="color: #666666">103</span>     <span style="color: #B00040">char</span> is_entity_exist;<br/><span style="color: #666666">104</span>     <span style="color: #B00040">char</span> is_header_processed;<br/><span style="color: #666666">105</span>     <span style="color: #B00040">char</span> is_to_submit;<br/><span style="color: #666666">106</span>     <span style="color: #B00040">char</span> is_submitted;<br/><span style="color: #666666">107</span>     <span style="color: #B00040">char</span> state;<br/><span style="color: #666666">108</span>     <span style="color: #B00040">ssize_t</span> request_entity_len;<br/><span style="color: #666666">109</span>     <span style="color: #B00040">ssize_t</span> request_entity_sent_bytes;<br/><span style="color: #666666">110</span>     <span style="color: #B00040">ssize_t</span> request_len;        <span style="color: #408080; font-style: italic">/* length of request data \*/</span><br/><span style="color: #666666">111</span>     HEADER_FIELD<span style="color: #666666">*</span> header_field_ptr;<br/><span style="color: #666666">112</span>     CONN_INFO<span style="color: #666666">*</span> cip;             <span style="color: #408080; font-style: italic">/* csf cip struct \*/</span><br/><span style="color: #666666">113</span>     STQ_HEAD patch_head;<br/><span style="color: #666666">114</span> }HTTP_REQUEST;<br/></pre></div>
<p>http_session_entry调用submit_request函数来发送到管道。</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">354</span>         r <span style="color: #666666">=</span> submit_request(<span style="color: #666666">0</span>, rqstpp, req_info, http_data_cleaner, http_request_responder,<span style="color: #666666">||</span>       <span style="color: #666666">0</span>);<br/></pre></div>
<p>submit_request函数设置REQUEST结构体类型变量rqstp.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">16</span> <span style="color: #008000; font-weight: bold">typedef</span> <span style="color: #008000; font-weight: bold">struct</span> request {<br/><span style="color: #666666">17</span>     TAILQ_ENTRY(request)    request_entry;<br/><span style="color: #666666">18</span>     <span style="color: #408080; font-style: italic">/* When the whole request data flow run over, call it \*/</span><br/><span style="color: #666666">19</span>     REQUEST_RESPONDER      <span style="color: #666666">*</span> request_responder;<br/><span style="color: #666666">20</span>     <span style="color: #B00040">void</span>                   <span style="color: #666666">*</span> proctocl_data; <span style="color: #408080; font-style: italic">/* lmtp_data_t \*/</span><br/><span style="color: #666666">21</span>     DATA_CLEANER           <span style="color: #666666">*</span> data_cleaner;  <span style="color: #408080; font-style: italic">/* To clean proctocl_data \*/</span><br/><span style="color: #666666">22</span>     <span style="color: #B00040">uint32_t</span>                pipeline_id;<br/><span style="color: #666666">23</span>     <span style="color: #B00040">uint64_t</span>                tid;            <span style="color: #408080; font-style: italic">/* Transation ID \*/</span><br/><span style="color: #666666">24</span>     <span style="color: #B00040">uint32_t</span>                nstage;         <span style="color: #408080; font-style: italic">/* stage counter*/</span><br/><span style="color: #666666">25</span>     <span style="color: #B00040">long</span>                    clock;          <span style="color: #408080; font-style: italic">/* clock of request for timeout \*/</span><br/><span style="color: #666666">26</span>     CONN_STATE             <span style="color: #666666">*</span> csp;<br/><span style="color: #666666">27</span>     <span style="color: #B00040">int</span>                     flags;<br/><span style="color: #666666">28</span>     <span style="color: #B00040">int</span>                     ret;<br/><span style="color: #666666">29</span>     <span style="color: #B00040">int</span>                     err;<br/><span style="color: #666666">30</span>     <span style="color: #B00040">uint32_t</span>                cancelled;      <span style="color: #408080; font-style: italic">/* cancelled is set by main thread \*/</span><br/><span style="color: #666666">31</span> } REQUEST;<br/></pre></div>
<p>request_responder保存响应处理函数。从前一个代码段可以看出，http中是http_request_responder</p>
<p>然后发送到管道：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">250</span>     <span style="color: #408080; font-style: italic">/* Play some tricks with the tmp_request_queue queue \*/</span><br/><span style="color: #666666">251</span>     <span style="color: #008000; font-weight: bold">if</span> (TAILQ_EMPTY(<span style="color: #666666">&amp;</span>(pcbp<span style="color: #666666">-&gt;</span>tmp_request_head))) {<br/><span style="color: #666666">252</span>         rc <span style="color: #666666">=</span> send_to_pipeline(pcbp, rqstp, flags, <span style="color: #666666">0</span>);<br/><span style="color: #666666">253</span>         <span style="color: #0000FF">if</span> (rc <span style="color: #666666">!=</span> <span style="color: #666666">0</span>) {<br/><span style="color: #666666">254</span>             <span style="color: #008000; font-weight: bold">return</span> (SUBMIT_GENERIC_ERROR);<br/><span style="color: #666666">255</span>         }<br/><span style="color: #666666">256</span>     } <span style="color: #008000; font-weight: bold">else</span> {<br/><span style="color: #666666">257</span>         <span style="color: #408080; font-style: italic">/* Secondary path. We have blocked requests to deal with \*/</span><br/><span style="color: #666666">258</span>         <span style="color: #408080; font-style: italic">/* add the request to the chain \*/</span><br/><span style="color: #666666">259</span>         rc <span style="color: #666666">=</span> send_to_pipeline(pcbp, rqstp, flags, <span style="color: #666666">1</span>);<br/><span style="color: #666666">260</span>         <span style="color: #0000FF">if</span> (rc <span style="color: #666666">!=</span> <span style="color: #666666">0</span>) {<br/><span style="color: #666666">261</span>             <span style="color: #008000; font-weight: bold">return</span> (SUBMIT_GENERIC_ERROR);<br/><span style="color: #666666">262</span>         }<br/><span style="color: #666666">263</span>     }<br/></pre></div>
<p>send_to_pipeline中使用了多线程处理。</p>
<p>管道也是非阻塞的，见server.c中：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">131</span>     <span style="color: #408080; font-style: italic">/* Set socket pipe \*/</span><br/><span style="color: #666666">132</span>     rc <span style="color: #666666">=</span> pipe(done_pipe);<br/><span style="color: #666666">133</span>     <span style="color: #0000FF">if</span> (rc <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>) {<br/><span style="color: #666666">134</span>         WLOG_ERR(<span style="color: #BA2121">&quot;Can&#39;t create pipe&quot;</span>);<br/><span style="color: #666666">135</span>         <span style="color: #008000; font-weight: bold">return</span> rc;<br/><span style="color: #666666">136</span>     }<br/><span style="color: #666666">137</span>     done_fd <span style="color: #666666">=</span> done_pipe[<span style="color: #666666">1</span>];<br/><span style="color: #666666">138</span>     done_fd_read <span style="color: #666666">=</span> done_pipe[<span style="color: #666666">0</span>];<br/><span style="color: #666666">139</span><br/><span style="color: #666666">140</span>     <span style="color: #408080; font-style: italic">/* Set nonblocked \*/</span><br/><span style="color: #666666">141</span>     rc <span style="color: #666666">=</span> fcntl(done_fd, F_GETFL, <span style="color: #666666">0</span>);<br/><span style="color: #666666">142</span>     <span style="color: #0000FF">if</span> (rc <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>) {<br/><span style="color: #666666">143</span>         WLOG_ERR(<span style="color: #BA2121">&quot;fcntl() error: %s&quot;</span>, strerror(errno));<br/><span style="color: #666666">144</span>         <span style="color: #008000; font-weight: bold">return</span> rc;<br/><span style="color: #666666">145</span>     }<br/><span style="color: #666666">146</span>     (<span style="color: #B00040">void</span>)fcntl(done_fd, F_SETFL, rc <span style="color: #666666">|</span> O_NONBLOCK);<br/><span style="color: #666666">147</span><br/><span style="color: #666666">148</span>     rc <span style="color: #666666">=</span> fcntl(done_fd_read, F_GETFL, <span style="color: #666666">0</span>);<br/><span style="color: #666666">149</span>     <span style="color: #0000FF">if</span> (rc <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>) {<br/><span style="color: #666666">150</span>         <span style="color: #008000; font-weight: bold">return</span> rc;<br/><span style="color: #666666">151</span>     }<br/><span style="color: #666666">152</span>     (<span style="color: #B00040">void</span>)fcntl(done_fd_read, F_SETFL, rc <span style="color: #666666">|</span> O_NONBLOCK);<br/></pre></div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id25">CSF线程树研究</a></h2>
<p>修改csf.conf配置文件，关闭monitor，http_io和http_upload线程值都为0时，线程树如下：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> pstree -p 16298<br/><span style="color: #808080">csfd(16298)───csfd-worker(16299)───{csfd-worker}(16300)</span><br/></pre></div>
<p>打开monitor，http_io和http_upload线程值仍为0时如下：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> pstree -p 16341<br/><span style="color: #808080">csfd(16341)───csfd-worker(16342)─┬─{csfd-worker}(16343)</span><br/><span style="color: #808080">                                 └─{csfd-worker}(16344)</span><br/></pre></div>
<p>关闭monitor，http_io线程值为1，http_upload值为0时</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> pstree -p 16465<br/><span style="color: #808080">csfd(16465)───csfd-worker(16466)─┬─{csfd-worker}(16467)</span><br/><span style="color: #808080">                                 └─{csfd-worker}(16468)</span><br/></pre></div>
<p>关闭monitor，http_io线程值为0，http_upload值为1时同上：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> pstree -p 16493<br/><span style="color: #808080">csfd(16493)───csfd-worker(16494)─┬─{csfd-worker}(16495)</span><br/><span style="color: #808080">                                 └─{csfd-worker}(16496)</span><br/></pre></div>
<p>打开monitor，http_io和http_upload的线程值都为1时：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> pstree -p 16534<br/><span style="color: #808080">csfd(16534)───csfd-worker(16535)─┬─{csfd-worker}(16536)</span><br/><span style="color: #808080">                                 ├─{csfd-worker}(16537)</span><br/><span style="color: #808080">                                 ├─{csfd-worker}(16538)</span><br/><span style="color: #808080">                                 └─{csfd-worker}(16539)</span><br/></pre></div>
<p>其中16537-16539包含上述三个服务。</p>
<p>这种情况下使用ab做测试：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> ab -n 40 -c 5 http://localhost/<br/><span style="color: #808080">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br/><span style="color: #808080">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br/><span style="color: #808080">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br/><br/><span style="color: #808080">Benchmarking localhost (be patient)...apr_socket_recv: Connection refused (111)</span><br/><span style="color: #808080">Total of 35 requests completed</span><br/></pre></div>
<p>通过大量测试，发现响应上限仍然在35左右。</p>
<p>修改配置文件恢复默认值：打开monitor，http_io和http_upload线程数都为200：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> pstree 16963<br/><span style="color: #808080">csfd───csfd-worker───402*[{csfd-worker}]</span><br/></pre></div>
<p>这里有402个线程。其中200个http_io，200个http_upload，1个monitor，1个系统本身的。</p>
</div>
<div class="section" id="apache-bench">
<h2><a class="toc-backref" href="#id26">Apache Bench 测试</a></h2>
<p>csf服务器地址为http://10.210.209.25:8080/ ，配置线程数256。</p>
<ul class="simple">
<li>从10.210.209.26发送请求5000次，并发数200：</li>
</ul>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> ab -n 5000 -c 200 http://10.210.209.25:8080/<br/><span style="color: #808080">...</span><br/><span style="color: #808080">Server Software:        CSF</span><br/><span style="color: #808080">Server Hostname:        10.210.209.25</span><br/><span style="color: #808080">Server Port:            8080</span><br/><br/><span style="color: #808080">Document Path:          /</span><br/><span style="color: #808080">Document Length:        135 bytes</span><br/><br/><span style="color: #808080">Concurrency Level:      200</span><br/><span style="color: #808080">Time taken for tests:   3.8833 seconds</span><br/><span style="color: #808080">Complete requests:      5000</span><br/><span style="color: #808080">Failed requests:        2</span><br/><span style="color: #808080">   (Connect: 0, Length: 2, Exceptions: 0)</span><br/><span style="color: #808080">Write errors:           0</span><br/><span style="color: #808080">Total transferred:      1464891 bytes</span><br/><span style="color: #808080">HTML transferred:       674865 bytes</span><br/><span style="color: #808080">Requests per second:    1661.77 [#/sec] (mean)</span><br/><span style="color: #808080">Time per request:       120.353 [ms] (mean)</span><br/><span style="color: #808080">Time per request:       0.602 [ms] (mean, across all concurrent requests)</span><br/><span style="color: #808080">Transfer rate:          475.27 [Kbytes/sec] received</span><br/><br/><span style="color: #808080">Connection Times (ms)</span><br/><span style="color: #808080">              min  mean[+/-sd] median   max</span><br/><span style="color: #808080">Connect:        0    7 152.8      0    3000</span><br/><span style="color: #808080">Processing:     1   52  43.3     50    1462</span><br/><span style="color: #808080">Waiting:        0   51  43.3     50    1460</span><br/><span style="color: #808080">Total:          6   59 156.4     50    3005</span><br/><br/><span style="color: #808080">Percentage of the requests served within a certain time (ms)</span><br/><span style="color: #808080">  50%     50</span><br/><span style="color: #808080">  66%     51</span><br/><span style="color: #808080">  75%     52</span><br/><span style="color: #808080">  80%     52</span><br/><span style="color: #808080">  90%     53</span><br/><span style="color: #808080">  95%     54</span><br/><span style="color: #808080">  98%     54</span><br/><span style="color: #808080">  99%    248</span><br/><span style="color: #808080"> 100%   3005 (longest request)</span><br/></pre></div>
<ul class="simple">
<li>对比apache测试（apache默认prefork线程数256）：</li>
</ul>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> ab -n 5000 -c 200 http://10.210.209.25:80/<br/><span style="color: #808080">...</span><br/><span style="color: #808080">Server Software:        Apache/2.2.3</span><br/><span style="color: #808080">Server Hostname:        10.210.209.25</span><br/><span style="color: #808080">Server Port:            80</span><br/><br/><span style="color: #808080">Document Path:          /</span><br/><span style="color: #808080">Document Length:        528 bytes</span><br/><br/><span style="color: #808080">Concurrency Level:      200</span><br/><span style="color: #808080">Time taken for tests:   1.418937 seconds</span><br/><span style="color: #808080">Complete requests:      5000</span><br/><span style="color: #808080">Failed requests:        0</span><br/><span style="color: #808080">Write errors:           0</span><br/><span style="color: #808080">Total transferred:      3495000 bytes</span><br/><span style="color: #808080">HTML transferred:       2640000 bytes</span><br/><span style="color: #808080">Requests per second:    3523.76 [#/sec] (mean)</span><br/><span style="color: #808080">Time per request:       56.757 [ms] (mean)</span><br/><span style="color: #808080">Time per request:       0.284 [ms] (mean, across all concurrent requests)</span><br/><span style="color: #808080">Transfer rate:          2405.32 [Kbytes/sec] received</span><br/><br/><span style="color: #808080">Connection Times (ms)</span><br/><span style="color: #808080">              min  mean[+/-sd] median   max</span><br/><span style="color: #808080">Connect:        0    0   0.6      0       5</span><br/><span style="color: #808080">Processing:     8   33 145.6     17    1414</span><br/><span style="color: #808080">Waiting:        8   33 145.6     17    1413</span><br/><span style="color: #808080">Total:          8   33 146.1     17    1418</span><br/><br/><span style="color: #808080">Percentage of the requests served within a certain time (ms)</span><br/><span style="color: #808080">  50%     17</span><br/><span style="color: #808080">  66%     18</span><br/><span style="color: #808080">  75%     18</span><br/><span style="color: #808080">  80%     18</span><br/><span style="color: #808080">  90%     18</span><br/><span style="color: #808080">  95%     21</span><br/><span style="color: #808080">  98%     28</span><br/><span style="color: #808080">  99%   1412</span><br/><span style="color: #808080"> 100%   1418 (longest request)</span><br/></pre></div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id27">遇到的问题及解决</a></h2>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id28">管道描述符错误</a></h3>
<p>在HTTP事件处理中，通过http_session_entry函数来响应用户请求。</p>
<p>处理用户请求时，在提交到管道时，出现了错误：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">349</span>     <span style="color: #408080; font-style: italic">/* submit to pipeline \*/</span><br/><span style="color: #666666">350</span>     <span style="color: #008000; font-weight: bold">if</span> (req_info<span style="color: #666666">-&gt;</span>is_to_submit <span style="color: #666666">==</span> <span style="color: #666666">1</span>)<br/><span style="color: #666666">351</span>     {<br/><span style="color: #666666">352</span>         req_info<span style="color: #666666">-&gt;</span>is_to_submit <span style="color: #666666">=</span> <span style="color: #666666">0</span>;<br/><span style="color: #666666">353</span><br/><span style="color: #666666">354</span>         r <span style="color: #666666">=</span> submit_request(<span style="color: #666666">0</span>, rqstpp, req_info, http_data_cleaner, http_request_responder, <span style="color: #666666">0</span>);<br/><span style="color: #666666">355</span>         <span style="color: #008000; font-weight: bold">if</span> (r <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>)<br/><span style="color: #666666">356</span>         {<br/><span style="color: #666666">357</span>             WLOG_ERR(<span style="color: #BA2121">&quot;pipeline error. %ld&quot;</span>, r);<br/><span style="color: #666666">358</span>             <span style="color: #008000; font-weight: bold">return</span> PROTOCOL_DISCONNECT;<br/><span style="color: #666666">359</span>         }<br/></pre></div>
<p>发现是r为-1， 从submit_request中查看r值：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">185</span>     <span style="color: #0000FF">if</span> (pipeline_id <span style="color: #666666">&gt;=</span> PIPELINE_SIZE) {<br/><span style="color: #666666">186</span>         WLOG_ERR(<span style="color: #BA2121">&quot;pipeline_id %d 超过PIPELINE_SIZE %d !&quot;</span>, pipeline_id, PIPELINE_SIZE);<br/><span style="color: #666666">187</span>         <span style="color: #008000; font-weight: bold">return</span> (SUBMIT_GENERIC_ERROR);<br/><span style="color: #666666">188</span>     }<br/></pre></div>
<p>添加了一条显示错误日志的信息，运行显示如下：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #808080">submit_request[186]: &quot;pipeline_id -1283393984 超过PIPELINE_SIZE 16 !&quot;</span><br/></pre></div>
<p>pipeline并不是期望的小整数。</p>
<p>定位到protocol.c中如下函数</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">44</span> <span style="color: #B00040">int</span><br/><span style="color: #666666">45</span> <span style="color: #0000FF">do_protocol_session_entry</span>(<span style="color: #B00040">void</span><span style="color: #666666">*</span> csp,<br/><span style="color: #666666">46</span>     CONN_INFO<span style="color: #666666">*</span> cip, <span style="color: #B00040">void</span><span style="color: #666666">*</span> prot_data, <span style="color: #B00040">void</span><span style="color: #666666">*</span> data, <span style="color: #B00040">int</span> len)<br/><span style="color: #666666">47</span> {<br/><span style="color: #666666">48</span>     <span style="color: #008000; font-weight: bold">if</span> (pc.protocol_session_entry <span style="color: #666666">!=</span> <span style="color: #008000">NULL</span>) {<br/><span style="color: #666666">49</span>         printf(<span style="color: #BA2121">&quot;%d</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>, csp);<br/><span style="color: #666666">50</span>         <span style="color: #008000; font-weight: bold">return</span> (pc.protocol_session_entry(csp, cip, prot_data, data, len));<br/><span style="color: #666666">51</span>     } <span style="color: #008000; font-weight: bold">else</span> {<br/><span style="color: #666666">52</span>         WLOG_ERR(<span style="color: #BA2121">&quot;protocol_session_entry() is NULL!&quot;</span>);<br/><span style="color: #666666">53</span>         <span style="color: #008000; font-weight: bold">return</span> (CSF_OK);<br/><span style="color: #666666">54</span>     }<br/><span style="color: #666666">55</span> }<br/></pre></div>
<p>其中50行的pc.protocol_session_entry是函数指针，指向上述http_session_entry函数.</p>
<p>从而csp是函数http_session_entry 中形参pipeline_id的实参。</p>
<p>do_protocol_session_entry由data.c中data_received函数调用，csf传入。</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">36</span> <span style="color: #B00040">int</span><br/><span style="color: #666666">37</span> <span style="color: #0000FF">data_received</span>(CONN_STATE<span style="color: #666666">*</span> csp, <span style="color: #B00040">void</span><span style="color: #666666">*</span> data, <span style="color: #B00040">int</span> len)<br/><span style="color: #666666">38</span> {<br/><span style="color: #666666">39</span>     <span style="color: #008000; font-weight: bold">if</span> (data <span style="color: #666666">==</span> <span style="color: #008000">NULL</span>) {<br/><span style="color: #666666">40</span>         WLOG_DEBUG(<span style="color: #BA2121">&quot;data is NULL!&quot;</span>);<br/><span style="color: #666666">41</span>         <span style="color: #008000; font-weight: bold">return</span> (CSF_OK);<br/><span style="color: #666666">42</span>     }<br/><span style="color: #666666">43</span><br/><span style="color: #666666">44</span>     ((<span style="color: #B00040">char</span><span style="color: #666666">*</span> )data)[len] <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;\0&#39;</span>;<br/><span style="color: #666666">45</span><br/><span style="color: #666666">46</span>     <span style="color: #0000FF">if</span> (csp <span style="color: #666666">==</span> <span style="color: #008000">NULL</span>) {<br/><span style="color: #666666">47</span>         <span style="color: #008000; font-weight: bold">return</span> (do_protocol_session_entry(<span style="color: #008000">NULL</span>, <span style="color: #008000">NULL</span>, <span style="color: #008000">NULL</span>, data, len));<br/><span style="color: #666666">48</span>     } <span style="color: #008000; font-weight: bold">else</span> {<br/><span style="color: #666666">49</span>         printf(<span style="color: #BA2121">&quot;%d</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>, csp);<br/><span style="color: #666666">50</span>         <span style="color: #008000; font-weight: bold">return</span> (do_protocol_session_entry(csp, <span style="color: #666666">&amp;</span>(csp<span style="color: #666666">-&gt;</span>ci),<br/><span style="color: #666666">51</span>             csp<span style="color: #666666">-&gt;</span>data, data, len));<br/><span style="color: #666666">52</span>     }<br/><span style="color: #666666">53</span> }<br/></pre></div>
<p>data_received函数由tcp.c中tcp_conn_handler函数调用，</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">622</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span><br/><span style="color: #666666">623</span> tcp_conn_handler(<span style="color: #B00040">int</span> fd, <span style="color: #B00040">short</span> event, <span style="color: #B00040">void</span><span style="color: #666666">*</span> arg)<br/><span style="color: #666666">624</span> {<br/><span style="color: #666666">625</span>     <span style="color: #B00040">ssize_t</span>         len;<br/><span style="color: #666666">626</span>     <span style="color: #B00040">int</span>             val;<br/><span style="color: #666666">627</span>     <span style="color: #B00040">int</span>             rc;<br/><span style="color: #666666">628</span>     CONN_STATE     <span style="color: #666666">*</span> csp <span style="color: #666666">=</span> (CONN_STATE<span style="color: #666666">*</span> )arg;<br/><span style="color: #666666">629</span>     <span style="color: #008000; font-weight: bold">struct</span> timeval  tv;<br/>    ...<br/><span style="color: #666666">664</span>         } <span style="color: #008000; font-weight: bold">else</span> {<br/><span style="color: #666666">665</span>             recv_data[len] <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;\0&#39;</span>;<br/><span style="color: #666666">666</span>             rc <span style="color: #666666">=</span> data_received(csp, recv_data, len);<br/></pre></div>
<p>tcp_conn_handler在tcp_socket_event_handler中注册:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">756</span>     <span style="color: #408080; font-style: italic">/* Add the new connection event to event loop \*/</span><br/><span style="color: #666666">757</span>     event_set(<span style="color: #666666">&amp;</span>(csp<span style="color: #666666">-&gt;</span>ev), connfd, EV_READ, tcp_conn_handler, csp);<br/></pre></div>
<p>修改submit_request函数参数顺序，搞定！ support by terry.</p>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id29">响应请求不超过40次错误</a></h3>
<p>这是amoblin在对http_io.c进行小修改时不小心造成的。看这里：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">539</span>     memset(file_buffer, <span style="color: #666666">0</span>, <span style="color: #008000; font-weight: bold">sizeof</span>(file_buffer));<br/><span style="color: #666666">540</span>     memset(http_200, <span style="color: #666666">0</span>, <span style="color: #008000; font-weight: bold">sizeof</span>(http_200));<br/><span style="color: #666666">541</span>     <span style="color: #0000FF">while</span>(fgets(file_buffer, <span style="color: #008000; font-weight: bold">sizeof</span>(file_buffer), handler) <span style="color: #666666">!=</span> <span style="color: #008000">NULL</span> ) {<br/><span style="color: #666666">542</span>         strncat(http_200, file_buffer, strlen(file_buffer) );<br/><span style="color: #666666">543</span>     }<br/></pre></div>
<p>由于之前少些了540行，导致在每次请求后，htt_200越来越大，最终数组越界，程序异常退出。</p>
</div>
<div class="section" id="ab">
<h3><a class="toc-backref" href="#id30">之前ab测试</a></h3>
<p>使用Apache自带的apachebench做测试：</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> ab -n 35 -c 10 http://10.210.209.25/<br/><span style="color: #808080">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br/><span style="color: #808080">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br/><span style="color: #808080">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br/><br/><span style="color: #808080">Benchmarking 10.210.209.25 (be patient).....done</span><br/><br/><br/><span style="color: #808080">Server Software:        CSF</span><br/><span style="color: #808080">Server Hostname:        10.210.209.25</span><br/><span style="color: #808080">Server Port:            80</span><br/><br/><span style="color: #808080">Document Path:          /</span><br/><span style="color: #808080">Document Length:        135 bytes</span><br/><br/><span style="color: #808080">Concurrency Level:      10</span><br/><span style="color: #808080">Time taken for tests:   0.481 seconds</span><br/><span style="color: #808080">Complete requests:      35</span><br/><span style="color: #808080">Failed requests:        2</span><br/><span style="color: #808080">   (Connect: 0, Receive: 0, Length: 2, Exceptions: 0)</span><br/><span style="color: #808080">Write errors:           0</span><br/><span style="color: #808080">Total transferred:      9504 bytes</span><br/><span style="color: #808080">HTML transferred:       4455 bytes</span><br/><span style="color: #808080">Requests per second:    72.82 [#/sec] (mean)</span><br/><span style="color: #808080">Time per request:       137.328 [ms] (mean)</span><br/><span style="color: #808080">Time per request:       13.733 [ms] (mean, across all concurrent requests)</span><br/><span style="color: #808080">Transfer rate:          19.31 [Kbytes/sec] received</span><br/><br/><span style="color: #808080">Connection Times (ms)</span><br/><span style="color: #808080">              min  mean[+/-sd] median   max</span><br/><span style="color: #808080">Connect:        5   37  15.9     42      56</span><br/><span style="color: #808080">Processing:    18   47  64.8     32     377</span><br/><span style="color: #808080">Waiting:        0   29  12.8     29      60</span><br/><span style="color: #808080">Total:         38   84  62.2     74     398</span><br/><br/><span style="color: #808080">Percentage of the requests served within a certain time (ms)</span><br/><span style="color: #808080">  50%     74</span><br/><span style="color: #808080">  66%     78</span><br/><span style="color: #808080">  75%     78</span><br/><span style="color: #808080">  80%     82</span><br/><span style="color: #808080">  90%    101</span><br/><span style="color: #808080">  95%    222</span><br/><span style="color: #808080">  98%    398</span><br/><span style="color: #808080">  99%    398</span><br/><span style="color: #808080"> 100%    398 (longest request)</span><br/><br/><br/><span style="color: #000080; font-weight: bold">$</span> ab -n 35 -c 35 http://10.210.209.25/<br/><span style="color: #808080">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br/><span style="color: #808080">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br/><span style="color: #808080">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br/><br/><span style="color: #808080">Benchmarking 10.210.209.25 (be patient).....done</span><br/><br/><br/><span style="color: #808080">Server Software:        CSF</span><br/><span style="color: #808080">Server Hostname:        10.210.209.25</span><br/><span style="color: #808080">Server Port:            80</span><br/><br/><span style="color: #808080">Document Path:          /</span><br/><span style="color: #808080">Document Length:        135 bytes</span><br/><br/><span style="color: #808080">Concurrency Level:      35</span><br/><span style="color: #808080">Time taken for tests:   0.304 seconds</span><br/><span style="color: #808080">Complete requests:      35</span><br/><span style="color: #808080">Failed requests:        2</span><br/><span style="color: #808080">   (Connect: 0, Receive: 0, Length: 2, Exceptions: 0)</span><br/><span style="color: #808080">Write errors:           0</span><br/><span style="color: #808080">Total transferred:      9504 bytes</span><br/><span style="color: #808080">HTML transferred:       4455 bytes</span><br/><span style="color: #808080">Requests per second:    115.00 [#/sec] (mean)</span><br/><span style="color: #808080">Time per request:       304.360 [ms] (mean)</span><br/><span style="color: #808080">Time per request:       8.696 [ms] (mean, across all concurrent requests)</span><br/><span style="color: #808080">Transfer rate:          30.49 [Kbytes/sec] received</span><br/><br/><span style="color: #808080">Connection Times (ms)</span><br/><span style="color: #808080">              min  mean[+/-sd] median   max</span><br/><span style="color: #808080">Connect:        3   65  30.8     69     121</span><br/><span style="color: #808080">Processing:   142  170  17.5    167     197</span><br/><span style="color: #808080">Waiting:        0  159  43.2    163     196</span><br/><span style="color: #808080">Total:        151  235  44.7    231     302</span><br/><br/><span style="color: #808080">Percentage of the requests served within a certain time (ms)</span><br/><span style="color: #808080">  50%    229</span><br/><span style="color: #808080">  66%    267</span><br/><span style="color: #808080">  75%    276</span><br/><span style="color: #808080">  80%    284</span><br/><span style="color: #808080">  90%    297</span><br/><span style="color: #808080">  95%    302</span><br/><span style="color: #808080">  98%    302</span><br/><span style="color: #808080">  99%    302</span><br/><span style="color: #808080"> 100%    302 (longest request)</span><br/></pre></div>
<p>但有时也会出现这样的结果：</p>
<ul class="simple">
<li>错误：apr_socket_recv: Connection reset by peer (104)</li>
</ul>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> ab -n 35 -c 10 http://10.210.209.25/<br/><span style="color: #808080">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br/><span style="color: #808080">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br/><span style="color: #808080">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br/><br/><span style="color: #808080">Benchmarking 10.210.209.25 (be patient)...apr_socket_recv: Connection reset by peer (104)</span><br/><span style="color: #808080">Total of 33 requests completed</span><br/></pre></div>
<ul class="simple">
<li>错误：apr_socket_recv: Connection refused (111)</li>
</ul>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">$</span> ab -n 35 -c 1 http://10.210.209.25/<br/><span style="color: #808080">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br/><span style="color: #808080">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br/><span style="color: #808080">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br/><br/><span style="color: #808080">Benchmarking 10.210.209.25 (be patient)...apr_socket_recv: Connection refused (111)</span><br/><span style="color: #808080">Total of 34 requests completed</span><br/></pre></div>
</div>
</div>
</section>
<section class="meta">

<span class="tags">
  tagged by 
  
</span>

<span class="time">
  <time datetime="2011-12-12">2011-12-12</time>
</span>
</section>


        </article>
        <div id="copy">&copy; 2012 amoblin | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext ii">sext ii</a></div>
      </div>
    </div> <!--! end of #container -->
  </body>
</html>
